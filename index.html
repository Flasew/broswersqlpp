<!DOCTYPE html>
<html>
<head>

  <title>SQL++ SFW Query Processor</title>
  <link rel="stylesheet" type="text/css" href="webStyle.css">
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet">

  <script type="text/javascript" src="lib/require.js"></script>

</head>
 
<body>
  <h1>SFW Query Demo</h1>
  <div>
    <h2>Input 1: Environment Database (JSON Object)</h2>
    <textarea type="text" id="DB"></textarea>

  </div>

  <hr>

  <div>
    <h2>Input 2: SQL++ Query(SFW only)</h2>
    <textarea type="text" id="QUERY"></textarea><br />

    <button id="BUTTON">Enter inputs!</button>

  </div>

  <hr>

  <div>
    <h2>Binding Output of From Clause:</h2>
    <h2 id="FROM">
    </h2>
  </div>

  <hr>

  <div>
    <h2>Binding Output of Where Clause:</h2>
    <h2 id="WHERE">
    </h2>
  </div>

  <hr>

  <div>
    <h2>Binding Output of Group By Clause:</h2>
    <h2 id="GROUPBY">
    </h2>
  </div>

  <hr>

  <div>
    <h2>Binding Output of Having Clause:</h2>
    <h2 id="HAVING">
    </h2>
  </div>

  <hr>

  <div>
    <h2>Binding Output of Order By Clause:</h2>
    <h2 id="ORDERBY">
    </h2>
  </div>

  <hr>

  <div>
    <h2>Binding Output of Offset Clause:</h2>
    <h2 id="OFFSET">
    </h2>
  </div>

  <hr>

  <div>
    <h2>Binding Output of Limit Clause:</h2>
    <h2 id="LIMIT">
    </h2>
  </div>

  <hr>

  <div>
    <h2>Binding Output of Select Clause(Query Result):</h2>
    <h2 id="SELECT">
    </h2>
  </div>



  <script type="text/javascript">

    self.require = Tarp.require;
    var antlr4 = require('./node_modules/antlr4/index');
    var SqlppLexer = require('./parser/SqlppLexer').SqlppLexer;
    var SqlppParser = require('./parser/SqlppParser').SqlppParser;
    //var SqlppListener = require('./parser/SqlppListener').SqlppListener;
    var SqlppVisitor = require('./parser/CustomVisitor').CustomVisitor;


    //var input = "SELECT ELEMENT r.a FROM R AS r";


  </script>

  <script type="text/javascript" src="queryprocessor.js"></script>

  <script>
    
    var query = document.getElementById("QUERY");
    var envir = document.getElementById("DB");
    var button = document.getElementById("BUTTON");

    var fromArea = document.getElementById("FROM");
    var whereArea = document.getElementById("WHERE");
    var groupbyArea = document.getElementById("GROUPBY");
    var havingArea = document.getElementById("HAVING");
    var orderbyArea = document.getElementById("ORDERBY");
    var offsetArea = document.getElementById("OFFSET");
    var limitArea = document.getElementById("LIMIT");
    var selectArea = document.getElementById("SELECT");

    button.addEventListener("click", function(){
      var input = query.value;
      //console.log(input);
      var chars = new antlr4.InputStream(input);
      var lexer = new SqlppLexer(chars);
      var tokens  = new antlr4.CommonTokenStream(lexer);
      var parser = new SqlppParser(tokens);
      parser.buildParseTrees = true;
      var tree = parser.query();
      console.log(tree);

      var visitor = new SqlppVisitor();
      var ast = visitor.visit(tree);
      console.log(ast);

      //var listener = new SqlppListener();
      //antlr4.tree.ParseTreeWalker.DEFAULT.walk(listener, tree);

      var db = JSON.parse(envir.value);
      //var clause = JSON.parse(tree.value);

      var outputFrom = evalFrom(db, ast.from_clause);
      fromArea.innerHTML = JSON.stringify(outputFrom);

      var outputWhere = evalWhere(db, outputFrom, ast.where_clause);
      whereArea.innerHTML = JSON.stringify(outputWhere);

      var outputGroupBy = evalGroupby(db, outputWhere, ast.groupby_clause);
      groupbyArea.innerHTML = JSON.stringify(outputGroupBy);

      var outputHaving = evalHaving(db, outputGroupBy, ast.having_clause);
      havingArea.innerHTML = JSON.stringify(outputHaving);

      var outputOrderBy = evalOrderby(db, outputHaving, ast.orderby_clause);
      orderbyArea.innerHTML = JSON.stringify(outputOrderBy);

      var outputOffset = evalOffset(db, outputOrderBy, ast.offset_clause);
      offsetArea.innerHTML = JSON.stringify(outputOffset);

      var outputLimit = evalLimit(db, outputOffset, ast.limit_clause);
      limitArea.innerHTML = JSON.stringify(outputLimit);

      var outputSelect = evalSelect(db, outputLimit, ast.select_clause);
      selectArea.innerHTML = JSON.stringify(outputSelect);

      //console.log("Output of FROM Clause:");
      //console.log(outputFrom);
      //console.log("Output of WHERE Clause:");
      //console.log(outputWhere);
      //console.log("Output of GROUP BY Clause:");
      //console.log(outputGroupBy);
      //console.log("Output of HAVING Clause:");
      //console.log(outputHaving);
      //console.log("Output of ORDER BY Clause:");
      //console.log(outputOrderBy);
      //console.log("Output of OFFSET Clause:");
      //console.log(outputOffset);
      //console.log("Output of LIMIT Clause:");
      //console.log(outputLimit);
      //console.log("Output of SELECT Clause:");
      //console.log(outputSelect);
    });
  </script>
</body>

</html>